var _={},y={},M;function j(){if(M)return y;M=1,Object.defineProperty(y,"__esModule",{value:!0}),y.TimeClock=void 0;const h={interval:1e3};let v=class{constructor(a=h){this.clockOptions=a,this._isTiming=!1,this.nextExecuteTime=0,this.removeListener=r=>{const c=this.listeners.findIndex(n=>n===r);c>=0&&this.listeners.splice(c,1)},this.addListener=r=>{this.listeners.push(r)},this.subscribe=r=>(this.addListener(r),()=>this.unSubscribe(r)),this.unSubscribe=r=>{this.removeListener(r),this.listeners.length===0&&(this._isTiming=!1,this.clearTimeout())},this.startTiming=()=>{this._isTiming||this.listeners.length===0||(this.nextExecuteTime=this.now+this.options.interval,this._isTiming=!0,this.schedule())},this.stopTiming=()=>{this._isTiming=!1,this.clearTimeout()},this.notify=()=>{if(!this._isTiming)return;const{listeners:r}=this,c=this.now;r.forEach(n=>{n.call(null,{value:c,isOver:!1})})},this.schedule=()=>{const{interval:r}=this.options,c=performance.now();let n=this.nextExecuteTime-c;if(n<0){this.clearTimeout(),this.nextExecuteTime+=r,this.notify(),this._isTiming&&this.schedule();return}this.ticket=setTimeout(()=>{this.nextExecuteTime+=r,this.notify(),this._isTiming&&this.schedule()},n)},this.clearTimeout=()=>{this.ticket&&clearTimeout(this.ticket),this.ticket=void 0},this.hasListener=r=>this.listeners.includes(r),this.listeners=[]}get options(){return Object.assign({},this.clockOptions)}get isTiming(){return this._isTiming}get now(){return performance.now()}};return y.TimeClock=v,y}var g={},k={},q;function A(){return q||(q=1,Object.defineProperty(k,"__esModule",{value:!0}),k.DefaultSubscribeOptions=void 0,k.DefaultSubscribeOptions={start:60*1e3,end:0,autoUnsubscribe:!0,step:1e3,name:"",isDecrease:!0,notifyOnSubscribe:!0}),k}var S={},P;function W(){if(P)return S;P=1,Object.defineProperty(S,"__esModule",{value:!0}),S.noop=void 0,S.isObject=d,S.isFunction=a,S.hasown=r,S.isTimeClock=c;const h=Object.prototype.hasOwnProperty,v=()=>{};S.noop=v;function d(n){return n!==null&&typeof n=="object"}function a(n){return typeof n=="function"}function r(n,s){return h.call(n,s)}function c(n){if(!d(n))return!1;const s=n;return a(s.subscribe)&&a(s.unSubscribe)&&a(s.startTiming)&&a(s.stopTiming)&&a(s.hasListener)&&"isTiming"in s&&"options"in s}return S}var x={},D;function G(){if(D)return x;D=1,Object.defineProperty(x,"__esModule",{value:!0}),x.createInstance=h;function h(v="uuid"){let d=0;return function(){return d++,`${v}-${d}`}}return x.default=h(),x}var I;function R(){if(I)return g;I=1;var h=g&&g.__rest||function(s,u){var i={};for(var e in s)Object.prototype.hasOwnProperty.call(s,e)&&u.indexOf(e)<0&&(i[e]=s[e]);if(s!=null&&typeof Object.getOwnPropertySymbols=="function")for(var t=0,e=Object.getOwnPropertySymbols(s);t<e.length;t++)u.indexOf(e[t])<0&&Object.prototype.propertyIsEnumerable.call(s,e[t])&&(i[e[t]]=s[e[t]]);return i},v=g&&g.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(g,"__esModule",{value:!0}),g.Counter=void 0;const d=A(),a=j(),r=W(),c=v(G());let n=class{constructor(u={interval:1e3}){this.unSubscribeClock=r.noop,this.subscribersMap=new Map,this.getClockFactorValue=i=>{const e=this.clock.options.interval;let t=e;if(typeof i.clockFactor=="number"&&(t=i.clockFactor),typeof i.clockFactor=="function"){const{listeners:l}=i,o=h(i,["listeners"]),p=i.clockFactor.call(o,e);typeof p=="number"&&(t=p)}return Math.ceil(t)},this.getSubscriberInitValue=i=>{const{start:e,isDecrease:t,step:l,end:o}=i,p=e,b=t?e-l:e+l,f=t?o>=e:e>=o;return{value:p,nextStepValue:b,isOver:f,end:o,start:e}},this.onUpdate=()=>{const i=this.getEnabledSubscribers();for(let e=0;e<i.length;e++){const t=i[e],{isOver:l,newValue:o,executable:p,nextStepValue:b}=this.getExecuteInfo(t);if(l||(t.value=o,!p))continue;t.nextStepValue=b;const{listeners:f}=t,m=[...f];let O=this.isOver(t);O&&this.clearIsOverSubscribe(),m.forEach(T=>T.call(null,{value:t.value,isOver:O}))}},this.subScribe=(i,e={})=>{const t=e.key||(0,c.default)(),l=Object.assign(Object.assign({},e),{key:t});this.registerSubscriber(i,l);const o=this;return Object.freeze({unSubscribe:()=>this.unSubscribe(i,t),get key(){return t},startListening:(b=!1)=>{const f=this.getSubscriber(t);if(!f)throw new Error(`key为${t}的订阅已经被取消`);const m=this.isOver(f);if(f.enabled&&!m)return console.warn("已经处于监听状态，无需重复调用");const{value:O,nextStepValue:T}=this.getSubscriberInitValue(f);f.enabled=!0,f.value=O,f.nextStepValue=T,this.check()},get isOver(){const b=o.getSubscriber(t);return b?o.isOver(b):!0},get enabled(){const b=o.getSubscriber(t);return b?b.enabled:!1},get isValid(){return o.hasSubscriber(t,i)}})},this.registerSubscriber=(i,e={})=>{const{key:t=(0,c.default)(),start:l=60*1e3,end:o=0,autoUnsubscribe:p=!0,step:b=1e3,name:f="",isDecrease:m=!0,notifyOnSubscribe:O=!0,clockFactor:T=this.clock.options.interval}=Object.assign({},d.DefaultSubscribeOptions,e);let V=this.subscribersMap.get(t);const{value:E,nextStepValue:$,isOver:z}=this.getSubscriberInitValue({start:l,end:o,step:b,isDecrease:m});if(V||(V={start:l,end:o,step:b,value:E,nextStepValue:$,listeners:[],autoUnsubscribe:p,key:t,name:f,isDecrease:m,notifyOnSubscribe:O,enabled:!1,clockFactor:T},this.subscribersMap.set(t,V)),V.listeners.push(i),O){const B=this.getSubScribeValue(t)||E;i.call(null,{value:B,isOver:z})}},this.getSubScribeValue=i=>{const e=this.getSubscriber(i);if(!e)return;const t=e.listeners;if(t.length!==0&&t.length>=1)return e.value},this.check=()=>{this.hasEnabledSubscribers()&&(this.clock.hasListener(this.onUpdate)||(this.unSubscribeClock=this.clock.subscribe(this.onUpdate)),!this.clock.isTiming&&this.clock.startTiming())},this.unSubscribe=(i,e)=>{const t=this.subscribersMap.get(e);if(!t)return;const l=t.listeners.findIndex(p=>p===i);if(l<0)return;t.listeners.splice(l,1),t.listeners.length===0&&this.subscribersMap.delete(e),this.hasEnabledSubscribers()||this.unSubscribeClock()},this.getSubscribers=()=>[...this.subscribersMap.values()].map(i=>Object.freeze(i)),this.hasSubscriber=(i,e)=>{const t=this.subscribersMap.get(i);return t?t.listeners.includes(e):!1},this.getSubscriber=i=>this.subscribersMap.get(i),this.getEnabledSubscribers=()=>Array.from(this.subscribersMap.values()).filter(i=>i.enabled),this.hasEnabledSubscribers=()=>this.getEnabledSubscribers().length>0,this.clock=(0,r.isTimeClock)(u)?u:new a.TimeClock(u)}isOver(u){const i=!!u.isDecrease,{value:e}=u;return i?e<=u.end:e>=u.end}getExecuteInfo(u){const i=this.getClockFactorValue(u),e=!!u.isDecrease,{value:t,nextStepValue:l,step:o}=u,p=this.isOver(u);if(e){const f=u.value-i;return{isOver:p,oldValue:t,newValue:f,executable:f<=u.nextStepValue,nextStepValue:l-o}}const b=u.value+i;return{isOver:p,oldValue:t,newValue:b,executable:b>=u.nextStepValue,nextStepValue:l+o}}clearIsOverSubscribe(){const u=this.getEnabledSubscribers();for(let i=0;i<u.length;i++){const e=u[i];if(this.getExecuteInfo(e).isOver&&e.autoUnsubscribe)for(let l=e.listeners.length-1;l>=0;l--){const o=e.listeners[l];this.unSubscribe(o,e.key)}}}};return g.Counter=n,g}var w={},F;function H(){if(F)return w;F=1,Object.defineProperty(w,"__esModule",{value:!0}),w.counter=void 0;const h=j(),v=R(),d=new h.TimeClock;return w.counter=new v.Counter(d),w}var C={},U;function J(){return U||(U=1,Object.defineProperty(C,"__esModule",{value:!0})),C}var L;function K(){return L||(L=1,function(h){var v=_&&_.__createBinding||(Object.create?function(a,r,c,n){n===void 0&&(n=c);var s=Object.getOwnPropertyDescriptor(r,c);(!s||("get"in s?!r.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return r[c]}}),Object.defineProperty(a,n,s)}:function(a,r,c,n){n===void 0&&(n=c),a[n]=r[c]}),d=_&&_.__exportStar||function(a,r){for(var c in a)c!=="default"&&!Object.prototype.hasOwnProperty.call(r,c)&&v(r,a,c)};Object.defineProperty(h,"__esModule",{value:!0}),d(j(),h),d(R(),h),d(H(),h),d(J(),h)}(_)),_}var X=K();export{X as d};
